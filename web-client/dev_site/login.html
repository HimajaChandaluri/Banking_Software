<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Web-Client Login Page</title>
    </head>
    <body>
        <p> Hi. This is the login page. </p>
        <div id="ui">
            <label for="Username">User Name:</label>
            <input type="text" id="Username" name="Username"><br><br>
            <label for="Password">Password:</label>
            <input type="password" id="Password" name="Password" minlength="8" required><br><br>
            <input type="button" value="Log In" onclick="onUserLogin()">
            <a href="password_reset.html">Forgot Password</a>
        </div>

        <script src="../backend/user_services.js"></script>
        <script src="../backend/redirect.js"></script>
        <script src="../backend/devutils.js"></script>
        <script>
            function onUserLogin() {
                // alert("User tried to login");
                var username = document.getElementById("Username").value;
                if(user_sign_in_as(username)) {
                    redirect_to_site("home.html");
                } else {
                    alert("Sign in failed. Please check username, and password.");
                }
            }
        </script>
        <script>
            // Test if user is already logged in
            if(get_current_user() === ""){
                // Test retrieving args passed from loader page
                var args = get_args_from_url();
                console.log(args);
                if (args === undefined || args.length == 0 || args[0] === "") {
                    var cachedInfo = check_cached_server_info();
                    console.log(cachedInfo);
                    if(cachedInfo["hostname"] === "" || cachedInfo["port"] === "") {
                        // Don't know where server is. Redirect to laoder page.
                        alert("No server info. Please set server location.");
                        redirect_to_site("../loader-test.html");
                    }
                    // Use previously cached server info
                    args[0] = cachedInfo["hostname"];
                    args[1] = cachedInfo["port"];
                }
                var tag = document.createElement("p");
                var serverInfoStr = "Server address: " + args[0];
                serverInfoStr += "\n";
                serverInfoStr += "Server port: " + args[1];
                var serverAddr = document.createTextNode("Hostname=" + args[0]);
                tag.appendChild(serverAddr);
                tag.appendChild(document.createElement("br"));
                var serverPort = document.createTextNode("Port=" + args[1]);
                tag.appendChild(serverPort);
                var element = document.getElementById("ui");
                element.appendChild(tag);
                // Cache server info for later use
                document.cookie = "hostname=" + args[0];
                document.cookie = "port=" + args[1];
            } else {
                redirect_to_site("home.html");
            }
        </script>
    </body>
</html>
